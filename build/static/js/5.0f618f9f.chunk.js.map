{"version":3,"sources":["pages/mobileHome.js","pages/mobileHome.module.css","components/withSocketio.js","globals/config.js","components/useDeviceOrientation.js"],"names":["gameStatus","MobileHomePage","useDeviceOrientation","moveCounter","permissionGranted","setMoveCounter","setPermissionGranted","useState","gameStage","setGameStage","gameSelected","setGameSelected","score","setScore","isJoined","setIsJoined","playerId","useParams","socket","useRef","joinRoom","DeviceOrientationEvent","requestPermission","then","response","catch","console","error","useEffect","current","withSocketio","host","config","socketioHost","eventEmitters","emitter","data","ack","result","alert","eventListeners","listener","callback","stageId","players","forEach","player","gameIdx","gameId","shake","emit","selectGame","newGameIdx","className","styles","wrapper","joinButton","onClick","selectButton","selected","module","exports","io","secure","on","log","event","direction","setDirection","speed","setSpeed","angle","setAngle","prevAngle","prevTime","window","addEventListener","updateDeviceStatus","removeEventListener","lastAccVec3","alpha","beta","gamma","timeNow","Date","now","timeDelta","angleNow","angleDelta","Math","sign","deltaX","abs","deltaY","deltaZ","prevMoveCounter","max"],"mappings":"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","file":"static/js/5.0f618f9f.chunk.js","sourcesContent":["import React, { useState, useEffect, useRef } from 'react';\r\nimport {useParams} from 'react-router-dom';\r\nimport useDeviceOrientation from 'components/useDeviceOrientation';\r\n\r\nimport withSocketio from 'components/withSocketio';\r\n\r\nimport config from 'globals/config';\r\n\r\nimport styles from './mobileHome.module.css';\r\n\r\nconst gameStatus = {\r\n  idle:      0,\r\n  waiting:   1,\r\n  selecting: 2,\r\n  selected:  3,\r\n  ready:     4,\r\n  started:   5,\r\n  result:    6,\r\n  offline:   7, // should be not able to get this signal\r\n}\r\nconst MobileHomePage = () => {\r\n  const [{moveCounter, permissionGranted}, {setMoveCounter, setPermissionGranted}] = useDeviceOrientation();\r\n  // const [permissionGranted, setPermissionGranted] = useState(false);\r\n  const [gameStage, setGameStage] = useState(gameStatus['idle']);\r\n  const [gameSelected, setGameSelected] = useState(0);\r\n  const [score, setScore] = useState(0);\r\n  const [isJoined, setIsJoined] = useState(false);\r\n  const playerId = useParams('playerId');\r\n  const socket = useRef(null);\r\n  const requestPermission = () => {\r\n    // setPermissionGranted(true);\r\n    // temp disable\r\n    if (typeof(DeviceOrientationEvent) === \"function\" && typeof(DeviceOrientationEvent.requestPermission) === \"function\") {\r\n      // alert('DeviceOrientationEvent.requestPermission');\r\n      DeviceOrientationEvent.requestPermission().then(response => {\r\n          if (response == 'granted') {\r\n            setPermissionGranted(true);\r\n            // window.addEventListener('deviceorientation', onMotion, false);\r\n            // window.addEventListener('deviceorientation', (e) => {\r\n            //   // do something with e\r\n            // })\r\n          }\r\n        })\r\n        .catch(console.error);\r\n    } else {\r\n      setPermissionGranted(true);\r\n      // alert('no DeviceOrientationEvent.requestPermission');\r\n      // window.addEventListener('deviceorientation', onMotion, false);\r\n    }\r\n  };\r\n  const joinRoom = () => {\r\n    if (!permissionGranted) {\r\n      // setPermissionGranted(true);\r\n      requestPermission();\r\n    } else {\r\n      // socket.current.emit('joinRoom', playerId);\r\n    }\r\n  }\r\n  useEffect(() => {\r\n    if (permissionGranted) {\r\n      socket.current = withSocketio({\r\n        host: config.socketioHost,\r\n        eventEmitters: [\r\n          {\r\n            emitter: 'joinRoom',\r\n            data: playerId,\r\n            ack: (result) => {\r\n              // alert(result);\r\n              if (result === \"failed, scan again\") {\r\n                alert(\"Room not found, please Scan the QRcode again.\")\r\n              }\r\n            }\r\n          }\r\n        ],\r\n        eventListeners: [\r\n          {\r\n            listener: 'gameStage',\r\n            callback: (stageId) => {\r\n              setGameStage(stageId);\r\n              if (stageId === gameStatus.selecting) {\r\n                setGameSelected(0);\r\n              }\r\n            }\r\n          },\r\n          {\r\n            listener: 'gameResult',\r\n            callback: (score) => {\r\n              setScore(score);\r\n            }\r\n          },\r\n          {\r\n            listener: 'playersInfo',\r\n            callback: (players) => {\r\n              players.forEach(player => {\r\n                if (player['playerId'] === playerId['playerId']) {\r\n                  setIsJoined(player['joined']);\r\n                }\r\n              });\r\n            }\r\n          },\r\n          {\r\n            listener: 'gameChoice',\r\n            callback: (gameIdx) => {\r\n              setGameSelected(gameIdx);\r\n            }\r\n          },\r\n          {\r\n            listener: 'gameSelected',\r\n            callback: (gameId) => {\r\n              setGameSelected(gameId);\r\n              // gameSelected.current = gameId;\r\n            }\r\n          },\r\n        ]\r\n      })\r\n    }\r\n  }, [permissionGranted]);\r\n  useEffect(() => {\r\n    if (moveCounter > 2) {\r\n      // socket.current.emit('shake');\r\n      shake();\r\n      setMoveCounter(0);\r\n    }\r\n  }, [moveCounter]);\r\n  const shake = () => {\r\n    socket.current.emit('shake');\r\n  }\r\n  const selectGame = (gameIdx) => {\r\n    socket.current.emit('selectGame', gameIdx, (newGameIdx) => {\r\n      setGameSelected(newGameIdx);\r\n    });\r\n\r\n  }\r\n  return <div className={styles.wrapper}>\r\n    {/* <div>{gameStage} {permissionGranted? 'true': 'false'}</div> */}\r\n    {{\r\n      [gameStatus.idle]: (\r\n        <button className={styles.joinButton} onClick={joinRoom}>Join Game!</button>\r\n      ),\r\n      [gameStatus.waiting]: (\r\n        isJoined?\r\n        <div className={styles.joinButton}>Wait for other players</div>:\r\n        <button className={styles.joinButton} onClick={joinRoom}>Join Game!</button>\r\n      ),\r\n      [gameStatus.selecting]: (\r\n        <div className={styles.joinButton}>\r\n          <button onClick={()=>selectGame(0)} className={styles.selectButton + (gameSelected === 0? ' ' + styles.selected: '')}>Game 1</button>\r\n          <br/>\r\n          <button onClick={()=>selectGame(1)} className={styles.selectButton + (gameSelected === 1? ' ' + styles.selected: '')}>Game 2</button>\r\n          <br/>\r\n          <button onClick={()=>selectGame(2)} className={styles.selectButton + (gameSelected === 2? ' ' + styles.selected: '')}>Game 3</button>\r\n        </div>\r\n      ),\r\n      [gameStatus.selected]: (\r\n        <div className={styles.joinButton}>Game {gameSelected + 1}</div>\r\n      ),\r\n      [gameStatus.ready]: (\r\n        <div className={styles.joinButton}>Ready</div>\r\n      ),\r\n      [gameStatus.started]: (\r\n        <button className={styles.joinButton} onClick={shake}>Shake!</button>\r\n      ),\r\n      [gameStatus.result]: (\r\n        <div className={styles.joinButton}>\r\n          Result\r\n          <div><b>{score}</b></div>\r\n        </div>\r\n      ),\r\n    }[gameStage]}\r\n  </div>;\r\n}\r\n\r\nexport default MobileHomePage;","// extracted by mini-css-extract-plugin\nmodule.exports = {\"wrapper\":\"mobileHome_wrapper__2dkv9\",\"joinButton\":\"mobileHome_joinButton__2dv24\",\"selectButton\":\"mobileHome_selectButton__13aoe\",\"selected\":\"mobileHome_selected__2QI_z\"};","import io from 'socket.io-client';\r\n\r\nconst withSocketio = ({\r\n  host,\r\n  eventListeners,\r\n  eventEmitters\r\n}) => {\r\n  const socket = io(host, {secure: false});\r\n  \r\n  // console.log(socket);\r\n  \r\n  socket.on('connect', () => {\r\n    console.log('connected !');\r\n    // socket.emit('joinRoom', props.match.match.params.userId);\r\n    // wait join result msg from server\r\n    eventEmitters.forEach(event => {\r\n      const ack = (typeof(event.ack) === \"function\"? event.ack: null);\r\n      socket.emit(event.emitter, event.data, ack);\r\n    });\r\n  });\r\n\r\n  eventListeners.forEach(event => {\r\n    socket.on(event.listener, event.callback);\r\n  });\r\n\r\n  return socket;\r\n}\r\n\r\nexport default withSocketio;","const config = {\r\n  socketioHost: 'shakeshakegame.heroku.com',\r\n  // socketioHost: '10.0.1.40:3003',\r\n};\r\n\r\nexport default config;","import React, {useState, useEffect, useRef} from 'react';\r\n\r\nconst useDeviceOrientation = () => {\r\n  const [permissionGranted, setPermissionGranted] = useState(false);\r\n  const [direction, setDirection] = useState(0);\r\n  const [speed, setSpeed] = useState(0);\r\n  const [angle, setAngle] = useState(0);\r\n  const [moveCounter, setMoveCounter] = useState(0);\r\n  let prevAngle = useRef(0);\r\n  let prevTime = useRef(0);\r\n  useEffect(() => {\r\n    if (permissionGranted) {\r\n      window.addEventListener('deviceorientation', updateDeviceStatus, false);\r\n    }\r\n    return () => {\r\n      window.removeEventListener('deviceorientation', updateDeviceStatus, false);\r\n    }\r\n  }, [permissionGranted]);\r\n\r\n  let lastAccVec3 = [null, null, null];\r\n  const threshold = 45;\r\n  const updateDeviceStatus = (event) => {\r\n    const {alpha, beta, gamma} = event;\r\n    const timeNow = Date.now();\r\n    const timeDelta = timeNow - prevTime.current;\r\n    const angleNow = alpha;\r\n    let angleDelta = angleNow - prevAngle.current;\r\n    prevTime.current = timeNow;\r\n    prevAngle.current = angleNow;\r\n    setAngle(angleNow);\r\n    setDirection(Math.sign(angleDelta));\r\n    setSpeed(angleDelta / timeDelta * 1000);\r\n    if (!(alpha && beta && gamma)) { return; }\r\n    let deltaX = Math.abs(alpha - lastAccVec3[0]);\r\n    let deltaY = Math.abs(beta - lastAccVec3[1]);\r\n    let deltaZ = Math.abs(gamma - lastAccVec3[2]);\r\n    if(deltaX + deltaY + deltaZ > threshold) {\r\n      setMoveCounter((prevMoveCounter) => {\r\n        return prevMoveCounter + 1;\r\n      })\r\n    } else {\r\n      setMoveCounter((prevMoveCounter) => {\r\n        return Math.max(0, prevMoveCounter - 1);\r\n      })\r\n    }\r\n    // setLastAccVec3([alpha, beta, gamma]);\r\n    lastAccVec3 = [alpha, beta, gamma];\r\n  }\r\n  \r\n  return [{\r\n    direction, \r\n    speed, \r\n    angle,\r\n    moveCounter,\r\n    permissionGranted\r\n  }, {\r\n    setPermissionGranted,\r\n    setMoveCounter\r\n  }];\r\n}\r\n\r\nexport default useDeviceOrientation;"],"sourceRoot":""}